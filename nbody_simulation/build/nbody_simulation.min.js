/*! nbody_simulation 2016-01-17 */
"use strict";var CircleBody=function(a,b,c,d,e){this.radius=c,this.mass=d,this.invMass=1/d,this.curr=new Point(a,b),this.prev=new Point(a,b),this.forces=new Point,this.g=new Path.Circle(this.curr,this.radius),this.g.fillColor=e,this.g.strokeColor=e,this.g.strokeWidth=1};CircleBody.prototype={get velocity(){return this.curr.subtract(this.prev)},set velocity(a){this.prev=curr.subtract(a)}},CircleBody.prototype.integrate=function(a,b){var c=this.curr.clone(),d=this.velocity.add(this.forces.multiply(a));this.curr=this.curr.add(d.multiply(b)),this.prev=c.clone(),this.forces=new Point},CircleBody.prototype.addForce=function(a){this.forces=this.forces.add(a.multiply(this.invMass))},CircleBody.prototype.draw=function(){this.g.position=this.curr};var NBodyContext=function(){this.initCanvas(),this.strategy=new OrbitStrategy,this.run()};NBodyContext.prototype.run=function(){var a=this;view.onFrame=function(b){a.strategy.simulate(),a.draw()}},NBodyContext.prototype.draw=function(){for(var a=0;a<this.strategy.getNumBodies();a++)this.strategy.bodies[a].draw()},NBodyContext.prototype.initCanvas=function(){var a=document.getElementById("myCanvas");paper.setup(a),paper.install(window)};var AbstractStrategy=function(a){this.G=a.gravity,this.damping=a.damping,this.timeStep=a.timeStep,this.dt2=Math.pow(this.timeStep,2),this.bodies=[],this.numBodies=0};AbstractStrategy.prototype.simulate=function(){this.accumulateForces(),this.integrate()},AbstractStrategy.prototype.getBodies=function(){return this.getBodies},AbstractStrategy.prototype.getNumBodies=function(){return this.numBodies},AbstractStrategy.prototype.integrate=function(){for(var a=0;a<this.numBodies;a++)this.bodies[a].integrate(this.dt2,this.damping)},AbstractStrategy.prototype.accumulateForces=function(){for(var a=new Point,b=0;b<this.numBodies;b++)for(var c=this.bodies[b],d=b+1;d<this.numBodies;d++){var e=this.bodies[d],f=e.curr.subtract(c.curr),g=f.x*f.x+f.y*f.y;a.angle=f.angle,a.length=this.G*c.mass*e.mass/g*g,c.addForce(a),a=a.multiply(-1),e.addForce(a)}};var CarpetStrategy=function(){AbstractStrategy.call(this,{timeStep:.2,gravity:.5,damping:.999});var a=50,b=50,c=12;this.numBodies=156;var d=this.getCenter(b,a,c,this.numBodies),e=2,f=.1,g="red",h="orange",i=0,j=new Point(d);this.bodies=[this.numBodies];for(var k=0;k<this.numBodies;k++){var l=k<this.numBodies/2?g:h;this.bodies[k]=new CircleBody(j.x,j.y,e,f,l),j.x+=a,i++>=c-1&&(j.x=d.x,j.y+=b,i=0)}};CarpetStrategy.prototype=Object.create(AbstractStrategy.prototype),CarpetStrategy.prototype.constructor=CarpetStrategy,CarpetStrategy.prototype.getCenter=function(a,b,c,d){var e=view.center,f=(c-1)*b/2,g=Math.ceil(d/c),h=(g-1)*a/2,i=e.x-f,j=e.y-h;return new Point(i,j)};var OrbitStrategy=function(){AbstractStrategy.call(this,{timeStep:.1,gravity:.5,damping:1});var a=view.center,b=new CircleBody(a.x,a.y,100,300,"orange"),c=new CircleBody(a.x,a.y+350,5,.1,"blue"),d=new CircleBody(a.x,a.y-250,4,.09,"red"),e=new CircleBody(a.x,a.y-450,6,.5,"green");this.bodies.push(b),this.bodies.push(c),this.bodies.push(d),this.bodies.push(e),this.numBodies=this.bodies.length,c.addForce(new Point(-200,0)),d.addForce(new Point(-100,0)),e.addForce(new Point(-800,0))};OrbitStrategy.prototype=Object.create(AbstractStrategy.prototype),OrbitStrategy.prototype.constructor=OrbitStrategy;var SpiralStrategy=function(){AbstractStrategy.call(this,{timeStep:.05,gravity:.1,damping:.999});var a=20,b=.3,c=.01;this.numBodies=150;var d=new Color(1,0,1,.9),e=new Color(1,.5,0,.9),f=view.center;f.x-=200;for(var g=1;g<=this.numBodies;g++){f.x+=Math.sin(.1*g)*a,f.y+=Math.cos(.1*g)*(a+=1);var h=g*b+1,i=g*c+1,j=g%2==0?d:e,k=new CircleBody(f.x,f.y,h,i,j);this.bodies.push(k)}};SpiralStrategy.prototype=Object.create(AbstractStrategy.prototype),SpiralStrategy.prototype.constructor=SpiralStrategy;